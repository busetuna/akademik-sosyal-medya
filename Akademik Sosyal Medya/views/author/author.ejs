<!DOCTYPE html>
<html lang="tr">
<head>
  <meta charset="UTF-8">
  <title><%= title %></title>
  <link rel="stylesheet" href="/css/partials/navbar.css">
  <link rel="stylesheet" href="/css/author/author.css">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    .abstract-refresh-notice {
      margin: 20px 0;
    }
    
    .compare-section {
      margin: 20px 0;
      padding: 20px;
      background: #f8f9fa;
      border-radius: 8px;
      border: 1px solid #dee2e6;
    }
    
    .compare-section h3 {
      margin-bottom: 15px;
      color: #333;
    }
    
    #myAbstract {
      width: 100%;
      min-height: 120px;
      padding: 10px;
      border: 2px solid #ddd;
      border-radius: 6px;
      font-family: Arial, sans-serif;
      font-size: 14px;
      resize: vertical;
    }
    
    #myAbstract:focus {
      outline: none;
      border-color: #4c6ef5;
    }
    
    #compareSelected {
      background: #4c6ef5;
      color: white;
      padding: 12px 24px;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      font-size: 16px;
      margin-top: 10px;
      transition: background 0.3s;
    }
    
    #compareSelected:hover:not(:disabled) {
      background: #364fc7;
    }
    
    #compareSelected:disabled {
      background: #6c757d;
      cursor: not-allowed;
    }
    
    .selection-info {
      margin-top: 10px;
      font-size: 14px;
      color: #666;
    }
    
    .no-articles {
      text-align: center;
      padding: 40px;
      color: #666;
      font-style: italic;
    }
  </style>
</head>
<body>
  <div class="author-page">
    <div class="author-layout">

      <!-- Sol KÄ±sÄ±m -->
      <div class="author-left">
        <div class="author-header">
          <div class="author-photo">
            <img src="<%= author.thumbnail || 'https://via.placeholder.com/80?text=ğŸ‘¤' %>" alt="Yazar FotoÄŸrafÄ±">
          </div>
          <div class="author-info">
            <h2><%= author.name %></h2>
            <p><%= author.affiliations || 'Affiliation bilgisi yok' %></p>
            <p><%= author.email || 'E-posta bilgisi yok' %></p>
            <div class="author-tags">
              <% if (author.interests && author.interests.length > 0) { %>
                <% author.interests.forEach(tag => { %>
                  <span><%= tag %></span>
                <% }) %>
              <% } else { %>
                <span>Alan belirtilmemiÅŸ</span>
              <% } %>
            </div>
          </div>
        </div>

        <!-- Makale Listesi -->
        <div class="article-table">
          <div class="article-row article-header">
            <div class="article-title">SEÃ‡ / BAÅLIK</div>
            <div class="article-cited">ALINTI</div>
            <div class="article-year">YIL</div>
          </div>

          <% if (articles && articles.length > 0) { %>
            <% articles.forEach((article, index) => { %>
              <div class="article-row" data-article-index="<%= index %>">
                <div class="article-title">
                  <input type="checkbox"
                         class="compare-checkbox"
                         id="chk-<%= index %>"
                         data-title="<%= article.title %>"
                         data-abstract="<%= article.abstract || 'Ã–zet bilgisi yok' %>">
                  <label for="chk-<%= index %>">
                    <a href="<%= article.link || '#' %>" target="_blank"><%= article.title %></a>
                    <div class="article-meta">
                      <%= article.authors || '' %><br>
                      <span class="journal"><%= article.publication || 'YayÄ±n bilgisi yok' %></span>
                    </div>
                  </label>
                </div>
                <div class="article-cited"><%= article.cited_by && article.cited_by.value ? article.cited_by.value : 0 %></div>
                <div class="article-year"><%= article.year || '-' %></div>
              </div>
            <% }) %>
          <% } else { %>
            <div class="no-articles">Bu yazara ait makale bulunamadÄ±.</div>
          <% } %>
        </div>

        <!-- KarÅŸÄ±laÅŸtÄ±rma BÃ¶lÃ¼mÃ¼ -->
        <% if (articles && articles.length > 0) { %>
        <div class="compare-section">
          <h3>ğŸ“‹ Makale KarÅŸÄ±laÅŸtÄ±rmasÄ±</h3>
          
          <label for="myAbstract"><strong>Kendi Ã–zetiniz:</strong></label>
          <textarea id="myAbstract" placeholder="Kendi Ã¶zetinizi buraya yazÄ±n..."></textarea>
          
          <div class="selection-info">
            <span id="selectionCount">0</span> makale seÃ§ildi
          </div>
          
          <button id="compareSelected" disabled>
            ğŸ” SeÃ§ilenleri KarÅŸÄ±laÅŸtÄ±r
          </button>
        </div>
        <% } %>
      </div>

      <!-- SaÄŸ KÄ±sÄ±m -->
      <div class="author-right">
        <div class="citation-box">
          <h4>AlÄ±ntÄ± Yapanlar</h4>
          <table>
            <thead>
              <tr><th></th><th>Toplam</th><th>2020+</th></tr>
            </thead>
            <tbody>
              <tr>
                <td>AlÄ±ntÄ±</td>
                <td><%= citations && citations.table && citations.table.citations && citations.table.citations.all ? citations.table.citations.all : 0 %></td>
                <td><%= citations && citations.table && citations.table.citations && citations.table.citations.since_2020 ? citations.table.citations.since_2020 : 0 %></td>
              </tr>
              <tr>
                <td>h-endeks</td>
                <td><%= citations && citations.table && citations.table.h_index && citations.table.h_index.all ? citations.table.h_index.all : 0 %></td>
                <td><%= citations && citations.table && citations.table.h_index && citations.table.h_index.since_2020 ? citations.table.h_index.since_2020 : 0 %></td>
              </tr>
              <tr>
                <td>i10-endeks</td>
                <td><%= citations && citations.table && citations.table.i10_index && citations.table.i10_index.all ? citations.table.i10_index.all : 0 %></td>
                <td><%= citations && citations.table && citations.table.i10_index && citations.table.i10_index.since_2020 ? citations.table.i10_index.since_2020 : 0 %></td>
              </tr>
            </tbody>
          </table>
          <canvas id="citationChart" width="100%" height="100"></canvas>
        </div>
      </div>

    </div>
  </div>

  <script>
    // Grafik oluÅŸturma - dinamik verilerle
    const ctx = document.getElementById('citationChart').getContext('2d');
    const chartData = JSON.parse('<%= JSON.stringify(citations && citations.graph ? citations.graph : { values: [] }) %>');

    if (chartData.values && chartData.values.length) {
      new Chart(ctx, {
        type: 'bar',
        data: {
          labels: chartData.values.map(d => d.year),
          datasets: [{
            label: 'AlÄ±ntÄ± SayÄ±sÄ±',
            data: chartData.values.map(d => d.citations),
            backgroundColor: '#4c6ef5'
          }]
        },
        options: {
          responsive: true,
          scales: {
            y: { beginAtZero: true }
          }
        }
      });
    } else {
      // Grafik verisi yoksa placeholder gÃ¶ster
      ctx.fillStyle = '#f8f9fa';
      ctx.fillRect(0, 0, ctx.canvas.width, ctx.canvas.height);
      ctx.fillStyle = '#6c757d';
      ctx.font = '14px Arial';
      ctx.textAlign = 'center';
      ctx.fillText('Grafik verisi bulunamadÄ±', ctx.canvas.width / 2, ctx.canvas.height / 2);
    }

    // Checkbox ve karÅŸÄ±laÅŸtÄ±rma sistemi
    document.addEventListener('DOMContentLoaded', () => {
      const checkboxes = document.querySelectorAll('.compare-checkbox');
      const compareBtn = document.getElementById('compareSelected');
      const myAbstractInput = document.getElementById('myAbstract');
      const selectionCount = document.getElementById('selectionCount');

      // EÄŸer karÅŸÄ±laÅŸtÄ±rma bÃ¶lÃ¼mÃ¼ yoksa (makale yoksa) scripti Ã§alÄ±ÅŸtÄ±rma
      if (!compareBtn || !myAbstractInput || !selectionCount) {
        return;
      }

      // Debug: Checkbox sayÄ±sÄ±nÄ± kontrol et
      console.log('Bulunan checkbox sayÄ±sÄ±:', checkboxes.length);

      function updateButtonState() {
        const checkedBoxes = Array.from(checkboxes).filter(cb => cb.checked);
        const hasMyAbstract = myAbstractInput.value.trim().length > 0;
        
        // Debug: SeÃ§ili checkbox sayÄ±sÄ±nÄ± logla
        console.log('SeÃ§ili checkbox sayÄ±sÄ±:', checkedBoxes.length);
        
        // SeÃ§im sayÄ±sÄ±nÄ± gÃ¼ncelle
        selectionCount.textContent = checkedBoxes.length;
        
        // Butonu etkinleÅŸtir/devre dÄ±ÅŸÄ± bÄ±rak
        compareBtn.disabled = !(checkedBoxes.length > 0 && hasMyAbstract);
      }

      // Event listener'larÄ± ekle
      checkboxes.forEach((cb, index) => {
        console.log(`Checkbox ${index} iÃ§in event listener ekleniyor`);
        cb.addEventListener('change', (e) => {
          console.log(`Checkbox ${index} deÄŸiÅŸti:`, e.target.checked);
          updateButtonState();
        });
      });
      
      myAbstractInput.addEventListener('input', updateButtonState);

      // KarÅŸÄ±laÅŸtÄ±rma butonu tÄ±klama olayÄ±
      compareBtn.addEventListener('click', async () => {
        const myAbstract = myAbstractInput.value.trim();
        if (!myAbstract) {
          alert('LÃ¼tfen kendi Ã¶zetinizi girin!');
          return;
        }

        const selectedAbstracts = Array.from(checkboxes)
          .filter(cb => cb.checked)
          .map(cb => {
            const abstract = cb.dataset.abstract;
            const title = cb.dataset.title;
            // Abstract yoksa veya Ã§ok kÄ±sa ise uyarÄ± ver
            if (!abstract || abstract === 'Ã–zet bilgisi yok' || abstract.length < 20) {
              console.warn(`Makale "${title}" iÃ§in yeterli abstract bilgisi yok`);
              return null;
            }
            return abstract;
          })
          .filter(abs => abs !== null);

        if (selectedAbstracts.length === 0) {
          alert('SeÃ§ilen makalelerin hiÃ§birinde yeterli abstract bilgisi yok. LÃ¼tfen abstract\'Ä± bulunan makaleler seÃ§in.');
          return;
        }

        // KarÅŸÄ±laÅŸtÄ±rma iÅŸlemi
        compareBtn.disabled = true;
        compareBtn.textContent = 'â³ KarÅŸÄ±laÅŸtÄ±rÄ±lÄ±yor...';

        try {
          const response = await fetch('/compare-abstracts', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ 
              myAbstract: myAbstract, 
              compareAbstracts: selectedAbstracts 
            }),
          });

          const data = await response.json();
          
          if (data.result) {
            // Sonucu gÃ¶ster
            alert("KarÅŸÄ±laÅŸtÄ±rma Sonucu:\n\n" + data.result);
            
            if (data.warning) {
              console.warn("UyarÄ±:", data.warning);
            }
          } else {
            alert("KarÅŸÄ±laÅŸtÄ±rma yapÄ±lamadÄ±. LÃ¼tfen tekrar deneyin.");
          }
        } catch (error) {
          console.error('KarÅŸÄ±laÅŸtÄ±rma hatasÄ±:', error);
          alert("Sunucu ile iletiÅŸimde hata oluÅŸtu. LÃ¼tfen tekrar deneyin.");
        } finally {
          compareBtn.disabled = false;
          compareBtn.textContent = 'ğŸ” SeÃ§ilenleri KarÅŸÄ±laÅŸtÄ±r';
          updateButtonState(); // Buton durumunu yeniden kontrol et
        }
      });

      // Sayfa yÃ¼klendiÄŸinde buton durumunu ayarla
      updateButtonState();
    });
  </script>
</body>
</html>